<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Adding pages to MP3</title>
</head>
<body>
<h1>Adding pages to the MolProbity3 web interface</h1>
This document is a tutorial on adding new web pages to the graphical
side of MolProbity, that is, the MolProbity that you use via a web
browser. Before reading this, it would be a VERY good idea to read
through <a href="UI_Framework.html">the document on MolProbity's UI
framework</a>. You don't have to understand all of it, but it really is
important to see the overview. After you finish this tutorial, you
should go back and read it again, and it should be clearer.<br>
<hr style="width: 100%; height: 2px;">
<h2>Overview</h2>
As an example, this tutorial describes adding the "simple kinemages"
feature to MolProbity3, the one that allows users to choose one of the
basic Prekin scripts to make a kinemage, and then allows them to view
it in KiNG or to download it.<br>
<br>
Here are the steps:<br>
<ol>
  <li>Create a class that displays a web page for the user input, so
the user can choose a Prekin script to run. This class is called a <span
 style="font-style: italic;">delegate</span> and will live in the <span
 style="font-family: monospace;">pages/</span> folder.</li>
  <li>Add a link to this delegate page from one or more of the existing
pages in MolProbity.</li>
  <li>Create a PHP script that runs Prekin and produces the kinemage,
based on the user input. This script will run as a background job and
lives in the <span style="font-family: monospace;">jobs/</span> folder.</li>
  <li>Create a class that displays a web page that presents the
finished kinemage to the user, with links for downloading and viewing.
This class is also a delegate and will also live in the <span
 style="font-family: monospace;">pages/</span> folder.</li>
</ol>
<hr style="width: 100%; height: 2px;">
<h2>User input page</h2>
Copy the file <span style="font-family: monospace;">template-page.php</span>
from <span style="font-family: monospace;">doc/extending/</span> into <span
 style="font-family: monospace;">pages/</span>, and give it a new name
(like <span style="font-family: monospace;">makekin_setup.php</span>).
The file <span style="font-family: monospace;">makekin_setup.php</span>
in fact already exists, so that you can follow along in it and see the
actual code that is summarized below. Every script in <span
 style="font-family: monospace;">pages/</span> declares a class, and
those classes must all have unique names. So, change "TemplateDelegate"
to something like "MakeKinSetupDelegate" (everywhere it appears -- 2
places).<br>
<br>
The template contains a fair bit of junk that we don't need, but there
are a lot of other <span style="font-family: monospace;"><span
 style="font-style: italic;">xxx</span>_setup.php</span> scripts that
can be plundered for example code. We're going to start in the <span
 style="font-family: monospace;">display()</span> function, which is
responsible for outputing the HTML web page that the user sees when
they get here. (We'll discuss <span style="font-style: italic;">how</span>
they get here later on.)<br>
<br>
Display should start with <span style="font-family: monospace;">mpPageHeader()</span>
and end with <span style="font-family: monospace;">mpPageFooter()</span>.
These two functions take care of creating the &lt;HTML&gt; and
&lt;BODY&gt; tags, including stylesheets, etc. The header can
optionally generate a sidebar of links, timed commands to refresh the
page, and other things. Look it up in <span
 style="font-family: monospace;">core.php</span>.<br>
<br>
<span style="color: rgb(255, 0, 0);"></span>The core content of the
page is quite simple: a list of radio buttons
for selecting the model (PDB file) to work with, a similar list of
buttons for the Prekin scripts, and a &lt;FORM&gt; to hold them. In
order for event handling to work properly, the form must be created
with the <span style="font-family: monospace;">makeEventForm()</span>
function, although it needs to be ended by a normal <span
 style="font-family: monospace;">&lt;/form&gt;</span> tag.<br>
<br>
The Prekin-script radio buttons are arranged in a table for easier
formatting, with
alternating colors for the rows. All the radio buttons have the same <span
 style="font-family: monospace;">name='scriptName'</span>, which is
what makes them act as a group (only one member of the group can be
selected at any given time). Each radio button has a different <span
 style="font-family: monospace;">value</span>, which we will use later
to decide which Prekin script to run.<br>
<br>
The buttons for selecting a model are very similar, and were in fact
stolen from one of the other <span style="font-family: monospace;"><span
 style="font-style: italic;">xxx</span>_setup.php</span> scripts. All
these buttons have <span style="font-family: monospace;">name='modelID'</span>.
Many things in MolProbity do not need to be reinvented -- there is
either a reuseable function available, or there is existing code that
can form a good starting point. In this case, we choose to copy and
modify because our requirements are subtly different from those of the
other pages.<br>
<br>
There are two submit buttons for this form, which both have <span
 style="font-family: monospace;">name='cmd'</span>. The text in their <span
 style="font-family: monospace;">value</span> property is what appears
as the button text, and it's what we'll use in a minute to decide which
one the user pressed, and whether they want to run Prekin or cancel
this operation.<br>
<br>
The other thing we need to declare is a function to handle the
form-submission event. We call it <span style="font-family: monospace;">onRunPrekin()</span>,
because that's the name we passed to <span
 style="font-family: monospace;">makeEventForm()</span> back in <span
 style="font-family: monospace;">display()</span>. It gets two
arguments. The first one, <span style="font-family: monospace;">$arg</span>,
has no meaningful value, because we didn't specify it in <span
 style="font-family: monospace;">makeEventForm()</span>. This feature
exists to allow one function to handle many related &lt;FORM&gt;s, but
we only have one form that needs to be handled. The argument <span
 style="font-family: monospace;">$req</span>, on the other hand, is
identical to the PHP superglobal <span style="font-family: monospace;">$_REQUEST</span>:
it holds all the data submitted by the user in the form. The keys of <span
 style="font-family: monospace;">$req</span> are the <span
 style="font-family: monospace;">name</span>s of things in the form, so
our keys are <span style="font-family: monospace;">scriptName</span>
(from the radio buttons) and <span style="font-family: monospace;">cmd</span>
(from the submit buttons). The values in <span
 style="font-family: monospace;">$req</span> are the <span
 style="font-family: monospace;">value</span>s specified in the form.<br>
<br>
Thus, we first use <span style="font-family: monospace;">$req['cmd']</span>
to decide if the user pressed the Cancel button or the Make Kinemage
button. Pressing Cancel leads us to return to the previous page using <span
 style="font-family: monospace;">pageReturn()</span>. (This requires
that the previous page got here by calling <span
 style="font-family: monospace;">pageCall()</span> rather than <span
 style="font-family: monospace;">pageGoto()</span>, which we'll ensure
it does in just a minute.) For now, the other button should just do
nothing. Doing nothing will just cause our form to be displayed again.
In a while, we'll add code to actually run Prekin when the button is
pressed.<br>
<hr style="width: 100%; height: 2px;">
<h2>Linking to the input page</h2>
Now that we have an input page, we need to be able to see it. Because
it's not a typical, simple PHP web page, you can't just go to its URL.
This is actually deliberate and a huge advantage for a web application,
as described in the UI Framework document. However, that means that we
need to connect it to the real site in order to try it out. There are
two places where we want to link it: from the site map, and from the
quick-links sidebar.<br>
<br>
The site map is generated by <span style="font-family: monospace;">pages/sitemap.php</span>.
There are lots of links here, so it's easy to copy &amp; paste a good
example. The key call is this one:<br>
<br>
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; <span
 style="font-family: monospace;">makeEventURL("onNavBarCall",
"makekin_setup.php")</span><br style="font-family: monospace;">
<br>
</span>Unlike other uses of <span style="font-family: monospace;">makeEventURL()</span>
we've seen, this one has <span style="font-style: italic;">two</span>
arguments. The first is still the name of the function that will be
called when the user clicks on the link. The second one will be passed
to that function as it's <span style="font-family: monospace;">$arg</span>.
This allows one function (<span style="font-family: monospace;">onNavBarCall()</span>)
to handle jumping off in any number of directions. Incidentally, <span
 style="font-family: monospace;">onNavBarCall()</span> is defined in
the <span style="font-family: monospace;">BasicDelegate</span> class,
which is declared in <span style="font-family: monospace;">lib/event_page.php</span>.
If you go look at it, you'll see it just uses <span
 style="font-family: monospace;">pageCall()</span> to transfer control
to the named delegate page:<br>
<br>
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; function
onNavBarCall($arg, $req)</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; {</span><br
 style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
pageCall($arg);</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; }</span><br
 style="font-family: monospace;">
<br>
The very similar <span style="font-family: monospace;">onNavBarGoto()</span>
event handling function uses <span style="font-family: monospace;">pageGoto()</span>
instead, but is otherwise identical. It's not appropriate here, because
we want to be able to "call" the Prekin page from anywhere and always
return to where we started from when it finishes. The trade-off we make
is that the Prekin pages must not display the sidebar, lest the user
jump out of our nicely constructed "loop" of Prekin pages.<br>
<br>
We add our page to the sidebar in a similar way, by editing <span
 style="font-family: monospace;">lib/core.php</span>. (Not really
ideal, is it? This function should live somewhere else, but it's stayed
in the core as a historical artifact.) In the <span
 style="font-family: monospace;">mpNavigationBar()</span> function,
duplicated one of the existing entries and modify it to look like this:<br>
<br>
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp; $s .=
mpNavBar_call('makekin_setup.php', 'Make simple kins');</span><br
 style="font-family: monospace;">
<br>
Now we've succeeded in linking our page into the main site. Try
accessing your local development copy of MolProbity, and on the Site
Map page you should see a link to the kinemage-creation page, as well
as a link in the sidebar.<br>
<hr style="width: 100%; height: 2px;">
<h2>Running Prekin</h2>
Now that we've got an interface, it would be nice if it actually did
something when the user pushed the button. For that, we'll need a
command-line PHP script that actually does the work in the background
while <span style="font-family: monospace;">pages/job_progress.php</span>
is displayed in the web browser to keep the user entertained. Create a
new background job by copying <span style="font-family: monospace;">doc/extending/template-job.php</span>
to <span style="font-family: monospace;">jobs/makekin.php</span>.<br>
<br>
Here we don't have to worry about delegates and all that mess -- this
script runs in a much more straightforward manner. However, you'll
notice that it has to explicitly load the session data and initialize
the MolProbity environment in the first few lines of the script. These
chores are done for the delegate pages by <span
 style="font-family: monospace;">public_html/index.php</span>, so they
never have to bother with it.<br>
<br>
<br>
</body>
</html>
